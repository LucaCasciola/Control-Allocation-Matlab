<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">u</span> = CascadedPseudoinverse(<span class="var type1" id="S3T2U6">m</span>, <span class="var type1" id="S4T3U7">B</span>, <span class="var type1" id="S5T4U8">W</span>, <span class="var type1" id="S6T5U9">u_lim</span>, <span class="var type1" id="S7T6U10">reductionType</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">coder.varsize(<span class="string">'u_index'</span>, <span class="string">'Br'</span>, <span class="string">'Wr'</span>, <span class="string">'u_sat'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%check if the matrices are correct</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">    <span class="keyword">if</span> not(<span class="mxinfo " id="T7:U7">isequal(<span class="mxinfo " id="T8:U8">size(<span class="var type1" id="S6T5U29">u_lim</span>,1)</span>,<span class="mxinfo " id="T8:U10">size(<span class="var type1" id="S4T3U33">B</span>,2)</span>,<span class="mxinfo " id="T8:U12">size(<span class="var type1" id="S5T4U37">W</span>,1)</span>,<span class="mxinfo " id="T8:U14">size(<span class="var type1" id="S5T4U41">W</span>,2)</span>)<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line">       &amp;&amp; isequal(<span class="mxinfo " id="T9:U16">length(<span class="var type1" id="S3T2U47">m</span>)</span>,<span class="mxinfo " id="T8:U18">size(<span class="var type1" id="S4T3U50">B</span>,1)</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line">        error (<span class="string">'input matrix dimensions do not match'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">%assign to every equation an index    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">    <span class="mxinfo " id="T10:U20"><span class="var type1" id="S14T10U58">u_index</span> = <span class="mxinfo " id="T1:U22"><span class="mxinfo " id="T11:U23">[1:<span class="mxinfo " id="T8:U24">length(<span class="var type1" id="S6T5U66">u_lim</span>)</span>]</span>.'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">%check the type of system and then compute the pseudoinverse 1st step</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">    <span class="mxinfo " id="T6:U26"><span class="var type1" id="S15T6U69">order</span> = <span class="mxinfo " id="T6:U28"><span class="mxinfo " id="T8:U29">size(<span class="var type1" id="S4T3U73">B</span>,2)</span>-<span class="mxinfo " id="T8:U31">size(<span class="var type1" id="S4T3U77">B</span>,1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S15T6U82">order</span> &gt; 0 <span class="comment">%over-determined, solution that minimizes the 2norm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">        <span class="mxinfo " id="T1:U34"><span class="var type1" id="S2T1U86">u</span> = <span class="mxinfo " id="T1:U36"><span class="mxinfo " id="T12:U37"><span class="mxinfo " id="T12:U38"><span class="mxinfo " id="T4:U39">inv(<span class="var type1" id="S5T4U92">W</span>)</span>*<span class="mxinfo " id="T12:U41"><span class="var type1" id="S4T3U94">B</span>'</span></span>*<span class="mxinfo " id="T13:U43">inv(<span class="mxinfo " id="T13:U44"><span class="mxinfo " id="T3:U45"><span class="var type1" id="S4T3U99">B</span>*<span class="mxinfo " id="T4:U47">inv(<span class="var type1" id="S5T4U102">W</span>)</span></span>*<span class="mxinfo " id="T12:U49"><span class="var type1" id="S4T3U104">B</span>'</span></span>)</span></span>*<span class="var type1" id="S3T2U105">m</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line">    <span class="keyword">elseif</span> <span class="var type0" id="S15T0U108">order</span> &lt; 0 <span class="comment">%under-determined, solution that minimizes the error</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line">        <span class="var type0" id="S2T0U112">u</span> = inv(<span class="var type0" id="S4T0U119">B</span>.'*<span class="var type0" id="S4T0U120">B</span>)*<span class="var type0" id="S4T0U122">B</span>.'*<span class="var type0" id="S3T0U123">m</span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line">    <span class="keyword">else</span> <span class="comment">%order = 0, sqared thus invertiBrle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line">        <span class="var type0" id="S2T0U127">u</span> = inv(<span class="var type0" id="S4T0U131">B</span>)*<span class="var type0" id="S3T0U132">m</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%check if the first iteration solution is correct then return    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U52">not(<span class="mxinfo " id="T7:U53"><span class="mxinfo " id="T7:U54">any(<span class="mxinfo " id="T14:U55"><span class="var type1" id="S2T1U141">u</span> &lt; <span class="mxinfo " id="T1:U57"><span class="var type1" id="S6T5U143">u_lim</span>(<span class="mxinfo " id="T15:U59">:</span>,<span class="mxinfo " id="T6:U60">1</span>)</span></span>)</span>||<span class="mxinfo " id="T7:U61">any(<span class="mxinfo " id="T14:U62"><span class="var type1" id="S2T1U149">u</span> &gt; <span class="mxinfo " id="T1:U64"><span class="var type1" id="S6T5U151">u_lim</span>(<span class="mxinfo " id="T15:U66">:</span>,<span class="mxinfo " id="T6:U67">2</span>)</span></span>)</span></span>)</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">        <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="comment">%The software continues only if the solution has to be reduced</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">%reduce their value</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">    <span class="keyword">switch</span> <span class="var type1" id="S7T6U156">reductionType</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U69">1</span> <span class="comment">%truncation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">            <span class="comment">%takes note of which one are out of their bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">                <span class="mxinfo " id="T10:U70"><span class="var type1" id="S18T10U161">u_sat</span> = <span class="mxinfo " id="T1:U72">zeros(<span class="mxinfo " id="T6:U73">length(<span class="var type1" id="S2T1U166">u</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">                <span class="mxinfo " id="T10:U75"><span class="mxinfo " id="T10:U76"><span class="var type1" id="S18T10U171">u_sat</span>(<span class="mxinfo " id="T14:U78"><span class="var type1" id="S2T1U173">u</span> &lt; <span class="mxinfo " id="T1:U80"><span class="var type1" id="S6T5U175">u_lim</span>(<span class="mxinfo " id="T15:U82">:</span>,<span class="mxinfo " id="T6:U83">1</span>)</span></span>)</span> = <span class="mxinfo " id="T6:U84">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">                <span class="mxinfo " id="T10:U85"><span class="mxinfo " id="T10:U86"><span class="var type1" id="S18T10U182">u_sat</span>(<span class="mxinfo " id="T14:U88"><span class="var type1" id="S2T1U184">u</span> &gt; <span class="mxinfo " id="T1:U90"><span class="var type1" id="S6T5U186">u_lim</span>(<span class="mxinfo " id="T15:U92">:</span>,<span class="mxinfo " id="T6:U93">2</span>)</span></span>)</span> = <span class="mxinfo " id="T6:U94">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">            <span class="comment">%trucate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">                <span class="mxinfo " id="T1:U95"><span class="var type1" id="S2T1U192">u</span> = <span class="mxinfo " id="T1:U97">min(<span class="var type1" id="S2T1U195">u</span>, <span class="mxinfo " id="T1:U99"><span class="var type1" id="S6T5U197">u_lim</span>(<span class="mxinfo " id="T15:U101">:</span>,<span class="mxinfo " id="T16:U102">2</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">                <span class="mxinfo " id="T1:U103"><span class="var type1" id="S2T1U202">u</span> = <span class="mxinfo " id="T1:U105">max(<span class="var type1" id="S2T1U205">u</span>, <span class="mxinfo " id="T1:U107"><span class="var type1" id="S6T5U207">u_lim</span>(<span class="mxinfo " id="T15:U109">:</span>,<span class="mxinfo " id="T16:U110">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U111">2</span> <span class="comment">%scaling solution -&gt; direction preserving</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">            <span class="comment">%reduce</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">                <span class="mxinfo " id="T1:U112"><span class="var type1" id="S22T1U214">a</span> = <span class="mxinfo " id="T1:U114">zeros(<span class="mxinfo " id="T6:U115">length(<span class="var type1" id="S2T1U219">u</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">                <span class="keyword">for</span> <span class="var type1" id="S23T6U223">i</span> = <span class="mxinfo " id="T1:U118"><span class="mxinfo " id="T6:U119">1</span>:<span class="mxinfo " id="T6:U120">length(<span class="var type1" id="S2T1U228">u</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">                    <span class="keyword">if</span> <span class="mxinfo " id="T7:U122"><span class="mxinfo " id="T6:U123"><span class="var type1" id="S2T1U233">u</span>(<span class="var type1" id="S23T6U234">i</span>)</span>&gt;<span class="mxinfo " id="T6:U126">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">                       <span class="mxinfo " id="T6:U127"><span class="mxinfo " id="T6:U128"><span class="var type1" id="S22T1U239">a</span>(<span class="var type1" id="S23T6U240">i</span>)</span> = <span class="mxinfo " id="T6:U131"><span class="mxinfo " id="T6:U132"><span class="var type1" id="S2T1U243">u</span>(<span class="var type1" id="S23T6U244">i</span>)</span>/<span class="mxinfo " id="T6:U135"><span class="var type1" id="S6T5U246">u_lim</span>(<span class="var type1" id="S23T6U247">i</span>,<span class="mxinfo " id="T16:U138">2</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">                    <span class="keyword">elseif</span> <span class="mxinfo " id="T7:U139"><span class="mxinfo " id="T6:U140"><span class="var type1" id="S2T1U252">u</span>(<span class="var type1" id="S23T6U253">i</span>)</span>&lt;<span class="mxinfo " id="T6:U143">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">                       <span class="mxinfo " id="T6:U144"><span class="mxinfo " id="T6:U145"><span class="var type1" id="S22T1U258">a</span>(<span class="var type1" id="S23T6U259">i</span>)</span> = <span class="mxinfo " id="T6:U148"><span class="mxinfo " id="T6:U149"><span class="var type1" id="S2T1U262">u</span>(<span class="var type1" id="S23T6U263">i</span>)</span>/<span class="mxinfo " id="T6:U152"><span class="var type1" id="S6T5U265">u_lim</span>(<span class="var type1" id="S23T6U266">i</span>,<span class="mxinfo " id="T16:U155">1</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">                    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">                       <span class="mxinfo " id="T6:U156"><span class="mxinfo " id="T6:U157"><span class="var type1" id="S22T1U272">a</span>(<span class="var type1" id="S23T6U273">i</span>)</span> = <span class="mxinfo " id="T6:U160">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">                    <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">                <span class="mxinfo " id="T6:U161"><span class="var type1" id="S24T6U277">a_max</span> = <span class="mxinfo " id="T6:U163">max(<span class="var type1" id="S22T1U280">a</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">                <span class="mxinfo " id="T1:U165"><span class="var type1" id="S2T1U283">u</span> = <span class="mxinfo " id="T1:U167"><span class="var type1" id="S2T1U285">u</span>/<span class="var type1" id="S24T6U286">a_max</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">            <span class="comment">%takes note of which one are out of their bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">                <span class="mxinfo " id="T10:U170"><span class="var type1" id="S18T10U289">u_sat</span> = <span class="mxinfo " id="T1:U172">zeros(<span class="mxinfo " id="T6:U173">length(<span class="var type1" id="S2T1U294">u</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">                <span class="mxinfo " id="T10:U175"><span class="mxinfo " id="T10:U176"><span class="var type1" id="S18T10U299">u_sat</span>(<span class="mxinfo " id="T14:U178"><span class="var type1" id="S2T1U301">u</span> == <span class="mxinfo " id="T1:U180"><span class="var type1" id="S6T5U303">u_lim</span>(<span class="mxinfo " id="T15:U182">:</span>,<span class="mxinfo " id="T6:U183">2</span>)</span></span>)</span> = <span class="mxinfo " id="T6:U184">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">                <span class="mxinfo " id="T10:U185"><span class="mxinfo " id="T10:U186"><span class="var type1" id="S18T10U310">u_sat</span>(<span class="mxinfo " id="T14:U188"><span class="var type1" id="S2T1U312">u</span> == <span class="mxinfo " id="T1:U190"><span class="var type1" id="S6T5U314">u_lim</span>(<span class="mxinfo " id="T15:U192">:</span>,<span class="mxinfo " id="T6:U193">1</span>)</span></span>)</span> = <span class="mxinfo " id="T6:U194">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%Recursively compute until solution is found or all the effectors are saturated</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">    <span class="mxinfo " id="T17:U195"><span class="var type1" id="S25T17U320">Br</span> = <span class="var type1" id="S4T3U321">B</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">    <span class="mxinfo " id="T17:U198"><span class="var type1" id="S26T17U324">Wr</span> = <span class="var type1" id="S5T4U325">W</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">while</span>(1) <span class="comment">%till we run out of effectors</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">        <span class="comment">%compute the residual moment</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">            <span class="mxinfo " id="T2:U201"><span class="var type1" id="S27T2U331">m_res</span> = <span class="mxinfo " id="T2:U203"><span class="var type1" id="S3T2U333">m</span> - <span class="mxinfo " id="T2:U205"><span class="var type1" id="S4T3U335">B</span>*<span class="var type1" id="S2T1U336">u</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">        <span class="comment">%reduce the system </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">            <span class="mxinfo " id="T10:U208"><span class="var type1" id="S14T10U340">u_index</span>(<span class="mxinfo " id="T18:U210"><span class="mxinfo " id="T10:U211"><span class="var type1" id="S18T10U342"><span class="message error" id="M1F1C">u_sat</span></span></span> == <span class="mxinfo " id="T6:U212">1</span></span>)= []</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">                <span class="keyword">if</span> <span class="mxinfo " id="T7:U213">isempty(<span class="var type1" id="S14T10U350">u_index</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">                    <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">            <span class="mxinfo " id="T17:U215"><span class="var type1" id="S25T17U355">Br</span>(:,<span class="mxinfo " id="T18:U217"><span class="var type1" id="S18T10U358">u_sat</span> == <span class="mxinfo " id="T6:U219">1</span></span>)=[]</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">            <span class="mxinfo " id="T17:U220"><span class="var type1" id="S26T17U365">Wr</span>(:,<span class="mxinfo " id="T18:U222"><span class="var type1" id="S18T10U368">u_sat</span> == <span class="mxinfo " id="T6:U224">1</span></span>)=[]</span>; <span class="mxinfo " id="T17:U225"><span class="var type1" id="S26T17U375">Wr</span>(<span class="mxinfo " id="T18:U227"><span class="var type1" id="S18T10U377">u_sat</span> == <span class="mxinfo " id="T6:U229">1</span></span>,:)=[]</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="comment">%check the type of system and then compute the pseudoinverse</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">            <span class="mxinfo " id="T6:U230"><span class="var type1" id="S15T6U384">order</span> = <span class="mxinfo " id="T6:U232"><span class="mxinfo " id="T6:U233">size(<span class="var type1" id="S25T17U388">Br</span>,2)</span>-<span class="mxinfo " id="T6:U235">size(<span class="var type1" id="S25T17U392">Br</span>,1)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T7:U237"><span class="var type1" id="S15T6U397">order</span> &gt; <span class="mxinfo " id="T6:U239">0</span></span> <span class="comment">%over-determined, solution that minimizes the 2norm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">                <span class="mxinfo " id="T10:U240"><span class="var type1" id="S29T10U401">ur</span> = <span class="mxinfo " id="T10:U242"><span class="mxinfo " id="T17:U243"><span class="mxinfo " id="T17:U244"><span class="mxinfo " id="T17:U245">inv(<span class="var type1" id="S26T17U407">Wr</span>)</span>*<span class="mxinfo " id="T17:U247"><span class="var type1" id="S25T17U409">Br</span>.'</span></span>*<span class="mxinfo " id="T17:U249">inv(<span class="mxinfo " id="T17:U250"><span class="mxinfo " id="T17:U251"><span class="var type1" id="S25T17U414">Br</span>*<span class="mxinfo " id="T17:U253">inv(<span class="var type1" id="S26T17U417">Wr</span>)</span></span>*<span class="mxinfo " id="T17:U255"><span class="var type1" id="S25T17U419">Br</span>.'</span></span>)</span></span>*<span class="var type1" id="S27T2U420">m_res</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">            <span class="keyword">elseif</span> <span class="mxinfo " id="T7:U258"><span class="var type1" id="S15T6U423">order</span> &lt; <span class="mxinfo " id="T6:U260">0</span></span> <span class="comment">%under-determined, solution that minimizes the error</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">                <span class="mxinfo " id="T10:U261"><span class="var type1" id="S29T10U427">ur</span> = <span class="mxinfo " id="T10:U263"><span class="mxinfo " id="T17:U264"><span class="mxinfo " id="T17:U265">inv(<span class="mxinfo " id="T17:U266"><span class="mxinfo " id="T17:U267"><span class="var type1" id="S25T17U434">Br</span>.'</span>*<span class="var type1" id="S25T17U435">Br</span></span>)</span>*<span class="mxinfo " id="T17:U270"><span class="var type1" id="S25T17U437">Br</span>.'</span></span>*<span class="var type1" id="S27T2U438">m_res</span></span></span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">            <span class="keyword">else</span> <span class="comment">%order = 0, sqared thus invertiBrle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">                <span class="mxinfo " id="T10:U273"><span class="var type1" id="S29T10U442">ur</span> = <span class="mxinfo " id="T10:U275"><span class="mxinfo " id="T17:U276">inv(<span class="var type1" id="S25T17U446">Br</span>)</span>*<span class="var type1" id="S27T2U447">m_res</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="comment">%sum the freshly new result with the pre existing u</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">            <span class="mxinfo " id="T1:U279"><span class="var type1" id="S30T1U450">ut</span> = <span class="var type1" id="S2T1U451">u</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">            <span class="mxinfo " id="T10:U282"><span class="mxinfo " id="T10:U283"><span class="var type1" id="S30T1U455">ut</span>(<span class="var type1" id="S14T10U456">u_index</span>,<span class="mxinfo " id="T16:U286">1</span>)</span> = <span class="mxinfo " id="T10:U287"><span class="mxinfo " id="T10:U288"><span class="var type1" id="S2T1U460">u</span>(<span class="var type1" id="S14T10U461">u_index</span>,<span class="mxinfo " id="T6:U291">1</span>)</span> + <span class="var type1" id="S29T10U463">ur</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">        <span class="comment">%reduce the solution, if needed. If not needed exit the cycle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T7:U293">not(<span class="mxinfo " id="T7:U294"><span class="mxinfo " id="T7:U295">any(<span class="mxinfo " id="T14:U296"><span class="var type1" id="S30T1U472">ut</span> &lt; <span class="mxinfo " id="T1:U298"><span class="var type1" id="S6T5U474">u_lim</span>(<span class="mxinfo " id="T15:U300">:</span>,<span class="mxinfo " id="T6:U301">1</span>)</span></span>)</span>||<span class="mxinfo " id="T7:U302">any(<span class="mxinfo " id="T14:U303"><span class="var type1" id="S30T1U480">ut</span> &gt; <span class="mxinfo " id="T1:U305"><span class="var type1" id="S6T5U482">u_lim</span>(<span class="mxinfo " id="T15:U307">:</span>,<span class="mxinfo " id="T6:U308">2</span>)</span></span>)</span></span>)</span> <span class="comment">%Wre found a solution then Brreak</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">                <span class="mxinfo " id="T1:U309"><span class="var type1" id="S2T1U487">u</span> = <span class="var type1" id="S30T1U488">ut</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">                <span class="keyword">return</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">            <span class="keyword">else</span> <span class="comment">%some deflectors are past their limit                    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">                <span class="comment">%reduce their value</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">                    <span class="keyword">switch</span> <span class="var type1" id="S7T6U492">reductionType</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">                        <span class="keyword">case</span> <span class="mxinfo " id="T6:U313">1</span> <span class="comment">%truncation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">                            <span class="comment">%takes note of which one are out of their bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">                                <span class="mxinfo " id="T10:U314"><span class="var type1" id="S18T10U497">u_sat</span> = <span class="mxinfo " id="T10:U316">zeros(<span class="mxinfo " id="T6:U317">length(<span class="var type1" id="S29T10U502">ur</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">                                <span class="mxinfo " id="T10:U319"><span class="mxinfo " id="T10:U320"><span class="var type1" id="S18T10U507">u_sat</span>(<span class="mxinfo " id="T18:U322"><span class="mxinfo " id="T10:U323"><span class="var type1" id="S30T1U510">ut</span>(<span class="var type1" id="S14T10U511">u_index</span>)</span> &lt; <span class="mxinfo " id="T10:U326"><span class="var type1" id="S6T5U513">u_lim</span>(<span class="var type1" id="S14T10U514">u_index</span>,<span class="mxinfo " id="T6:U329">1</span>)</span></span>)</span> = <span class="mxinfo " id="T6:U330">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">                                <span class="mxinfo " id="T10:U331"><span class="mxinfo " id="T10:U332"><span class="var type1" id="S18T10U520">u_sat</span>(<span class="mxinfo " id="T18:U334"><span class="mxinfo " id="T10:U335"><span class="var type1" id="S30T1U523">ut</span>(<span class="var type1" id="S14T10U524">u_index</span>)</span> &gt; <span class="mxinfo " id="T10:U338"><span class="var type1" id="S6T5U526">u_lim</span>(<span class="var type1" id="S14T10U527">u_index</span>,<span class="mxinfo " id="T6:U341">2</span>)</span></span>)</span> = <span class="mxinfo " id="T6:U342">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">                            </span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">                            <span class="comment">%truncate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">                                <span class="mxinfo " id="T10:U343"><span class="mxinfo " id="T10:U344"><span class="var type1" id="S2T1U533">u</span>(<span class="var type1" id="S14T10U534">u_index</span>)</span> = <span class="mxinfo " id="T10:U347">min(<span class="mxinfo " id="T10:U348"><span class="var type1" id="S30T1U538">ut</span>(<span class="var type1" id="S14T10U539">u_index</span>)</span>, <span class="mxinfo " id="T10:U351"><span class="var type1" id="S6T5U541">u_lim</span>(<span class="var type1" id="S14T10U542">u_index</span>,<span class="mxinfo " id="T16:U354">2</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">                                <span class="mxinfo " id="T10:U355"><span class="mxinfo " id="T10:U356"><span class="var type1" id="S2T1U547">u</span>(<span class="var type1" id="S14T10U548">u_index</span>)</span> = <span class="mxinfo " id="T10:U359">max(<span class="mxinfo " id="T10:U360"><span class="var type1" id="S2T1U552">u</span>(<span class="var type1" id="S14T10U553">u_index</span>)</span>, <span class="mxinfo " id="T10:U363"><span class="var type1" id="S6T5U555">u_lim</span>(<span class="var type1" id="S14T10U556">u_index</span>,<span class="mxinfo " id="T16:U366">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">                        <span class="keyword">case</span> <span class="mxinfo " id="T6:U367">2</span> <span class="comment">%scaling solution -&gt; direction preserving</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">                                <span class="mxinfo " id="T10:U368"><span class="var type1" id="S22T10U562">a</span> = <span class="mxinfo " id="T10:U370">zeros(<span class="mxinfo " id="T6:U371">length(<span class="var type1" id="S14T10U567">u_index</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">                                <span class="keyword">for</span> <span class="var type1" id="S23T6U571">i</span> = <span class="mxinfo " id="T10:U374"><span class="mxinfo " id="T6:U375">1</span>:<span class="mxinfo " id="T6:U376">length(<span class="var type1" id="S14T10U576">u_index</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">                                    <span class="keyword">if</span> <span class="mxinfo " id="T7:U378"><span class="mxinfo " id="T6:U379"><span class="var type1" id="S29T10U581">ur</span>(<span class="var type1" id="S23T6U582">i</span>)</span>&gt;<span class="mxinfo " id="T6:U382">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">                                       <span class="mxinfo " id="T6:U383"><span class="mxinfo " id="T6:U384"><span class="var type1" id="S22T10U587">a</span>(<span class="var type1" id="S23T6U588">i</span>)</span> = <span class="mxinfo " id="T6:U387"><span class="mxinfo " id="T6:U388"><span class="var type1" id="S29T10U591">ur</span>(<span class="var type1" id="S23T6U592">i</span>)</span>/(<span class="mxinfo " id="T6:U391"><span class="mxinfo " id="T6:U392"><span class="var type1" id="S6T5U596">u_lim</span>(<span class="mxinfo " id="T6:U394"><span class="var type1" id="S14T10U598">u_index</span>(<span class="var type1" id="S23T6U599">i</span>)</span>,<span class="mxinfo " id="T16:U397">2</span>)</span>-<span class="mxinfo " id="T6:U398"><span class="var type1" id="S2T1U602">u</span>(<span class="mxinfo " id="T6:U400"><span class="var type1" id="S14T10U604">u_index</span>(<span class="var type1" id="S23T6U605">i</span>)</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">                                    <span class="keyword">elseif</span> <span class="mxinfo " id="T7:U403"><span class="mxinfo " id="T6:U404"><span class="var type1" id="S29T10U609">ur</span>(<span class="var type1" id="S23T6U610">i</span>)</span>&lt;<span class="mxinfo " id="T6:U407">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">                                       <span class="mxinfo " id="T6:U408"><span class="mxinfo " id="T6:U409"><span class="var type1" id="S22T10U615">a</span>(<span class="var type1" id="S23T6U616">i</span>)</span> = <span class="mxinfo " id="T6:U412"><span class="mxinfo " id="T6:U413"><span class="var type1" id="S29T10U619">ur</span>(<span class="var type1" id="S23T6U620">i</span>)</span>/(<span class="mxinfo " id="T6:U416"><span class="mxinfo " id="T6:U417"><span class="var type1" id="S6T5U624">u_lim</span>(<span class="mxinfo " id="T6:U419"><span class="var type1" id="S14T10U626">u_index</span>(<span class="var type1" id="S23T6U627">i</span>)</span>,<span class="mxinfo " id="T16:U422">1</span>)</span>-<span class="mxinfo " id="T6:U423"><span class="var type1" id="S2T1U630">u</span>(<span class="mxinfo " id="T6:U425"><span class="var type1" id="S14T10U632">u_index</span>(<span class="var type1" id="S23T6U633">i</span>)</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">                                    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">                                       <span class="mxinfo " id="T6:U428"><span class="mxinfo " id="T6:U429"><span class="var type1" id="S22T10U638">a</span>(<span class="var type1" id="S23T6U639">i</span>)</span> = <span class="mxinfo " id="T6:U432">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">                                    <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">                                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">                                <span class="mxinfo " id="T6:U433"><span class="var type1" id="S24T6U643">a_max</span> = <span class="mxinfo " id="T6:U435">max(<span class="var type1" id="S22T10U646">a</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">                                <span class="mxinfo " id="T10:U437"><span class="var type1" id="S29T10U649">ur</span> = <span class="mxinfo " id="T10:U439"><span class="var type1" id="S29T10U651">ur</span>/<span class="var type1" id="S24T6U652">a_max</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">                            </span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">                            <span class="comment">%takes note of which one are out of their bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">                                <span class="mxinfo " id="T10:U442"><span class="var type1" id="S18T10U655">u_sat</span> = <span class="mxinfo " id="T10:U444">zeros(<span class="mxinfo " id="T6:U445">length(<span class="var type1" id="S29T10U660">ur</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">                                <span class="mxinfo " id="T10:U447"><span class="mxinfo " id="T10:U448"><span class="var type1" id="S18T10U665">u_sat</span>(<span class="mxinfo " id="T18:U450"><span class="var type1" id="S22T10U667">a</span> == <span class="var type1" id="S24T6U668">a_max</span></span>)</span> = <span class="mxinfo " id="T6:U453">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">                            </span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">                            <span class="comment">%sum the freshly new result with the pre existing u</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">                                <span class="mxinfo " id="T10:U454"><span class="mxinfo " id="T10:U455"><span class="var type1" id="S2T1U673">u</span>(<span class="var type1" id="S14T10U674">u_index</span>,<span class="mxinfo " id="T16:U458">1</span>)</span> = <span class="mxinfo " id="T10:U459"><span class="mxinfo " id="T10:U460"><span class="var type1" id="S2T1U678">u</span>(<span class="var type1" id="S14T10U679">u_index</span>,<span class="mxinfo " id="T6:U463">1</span>)</span> + <span class="var type1" id="S29T10U681">ur</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">                    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    </span></span>
</pre>
</body>
</html>
